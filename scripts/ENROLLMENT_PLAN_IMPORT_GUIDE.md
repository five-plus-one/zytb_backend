# 招生计划数据导入指南

## 概述
本指南介绍如何将包含招生计划信息的 Excel 文件导入到系统数据库中。

## 准备工作

### 1. Excel 文件格式要求
Excel 文件应包含以下列(表头):

| 列名 | 说明 | 是否必填 | 数据类型 |
|------|------|---------|---------|
| 年份 | 招生年份 | 是 | 数字 |
| 生源地 | 生源省份 | 是 | 文本 |
| 科类 | 科类(物理类/历史类等) | 是 | 文本 |
| 批次 | 录取批次 | 是 | 文本 |
| 院校代码 | 院校代码 | 是 | 文本 |
| 院校名称 | 院校名称 | 是 | 文本 |
| 院校专业组代码 | 院校专业组代码 | 否 | 文本 |
| 专业组代码 | 专业组代码 | 否 | 文本 |
| 专业组名称 | 专业组名称 | 否 | 文本 |
| 选科要求 | 选科要求说明 | 否 | 文本 |
| 专业代码 | 专业代码 | 是 | 文本 |
| 专业名称 | 专业名称 | 是 | 文本 |
| 专业备注 | 专业备注信息 | 否 | 文本 |
| 计划人数 | 招生计划人数 | 是 | 数字 |
| 学制 | 学制年限 | 否 | 数字 |
| 学费 | 学费(元/年) | 否 | 数字 |

### 2. 数据格式说明

- **年份**: 4位数字,如 "2024"
- **数字**: 纯数字格式,如 "50", "5000"
- **文本**: 其他所有文本信息
- **学费**: 可以使用 "5000" 或 "5000元/年" 格式,系统会自动识别数字

## 导入步骤

### 步骤 1: 更新数据库表结构

由于添加了新的表,首先需要更新数据库表结构:

```bash
# 启动开发服务器,TypeORM 会自动同步表结构
npm run dev
```

或者手动运行同步脚本:

```bash
ts-node scripts/syncDatabase.ts
```

### 步骤 2: 执行导入

将 Excel 文件放到合适的位置(如 `data` 目录),然后执行:

```bash
npm run import-enrollment-plans <Excel文件路径>
```

示例:
```bash
# 相对路径
npm run import-enrollment-plans ./data/enrollment_plans.xlsx

# 绝对路径
npm run import-enrollment-plans E:/data/enrollment_plans.xlsx
```

### 步骤 3: 查看导入结果

导入过程中会显示详细的日志信息:
- 成功导入的记录数
- 失败的记录数
- 详细的错误信息

## 重要说明

### 数据更新策略
- 唯一性判断基于: **年份 + 生源地 + 院校代码 + 专业代码 + 批次**
- 如果记录已存在,将**更新**该记录
- 如果记录不存在,将**创建**新记录

### 院校关联
- 系统会自动尝试根据院校代码关联到院校表
- 如果院校表中存在对应的院校代码,会自动建立关联
- 即使院校未关联,招生计划数据也会正常导入

### 错误处理
如果某条记录导入失败,会:
1. 显示具体的错误信息和行号
2. 继续导入其他记录
3. 最后汇总显示所有错误

### 必填字段验证
以下字段为必填项,缺少这些字段的记录会被跳过:
- 年份
- 生源地
- 院校代码
- 院校名称
- 专业代码
- 专业名称
- 计划人数

## 示例 Excel 文件

```
年份 | 生源地 | 科类   | 批次     | 院校代码 | 院校名称 | 专业代码 | 专业名称       | 计划人数 | 学制 | 学费
2024 | 浙江省 | 物理类 | 本科一批 | 10001    | 北京大学 | 080901   | 计算机科学与技术 | 50      | 4    | 5000
2024 | 浙江省 | 物理类 | 本科一批 | 10002    | 清华大学 | 080901   | 计算机科学与技术 | 48      | 4    | 5000
```

## 数据查询示例

导入完成后,可以通过以下方式查询数据:

### 1. 按年份和生源地查询
```sql
SELECT * FROM enrollment_plans
WHERE year = 2024 AND source_province = '浙江省';
```

### 2. 按院校查询
```sql
SELECT * FROM enrollment_plans
WHERE college_code = '10001' AND year = 2024;
```

### 3. 按专业查询
```sql
SELECT * FROM enrollment_plans
WHERE major_name LIKE '%计算机%' AND year = 2024;
```

### 4. 统计各院校计划人数
```sql
SELECT college_name, SUM(plan_count) as total_count
FROM enrollment_plans
WHERE year = 2024 AND source_province = '浙江省'
GROUP BY college_name
ORDER BY total_count DESC;
```

## 故障排查

### 问题 1: 数据库连接失败
检查 `.env` 文件中的数据库配置:
```env
DB_HOST=localhost
DB_PORT=3307
DB_USER=root
DB_PASSWORD=123456
DB_NAME=volunteer_system
```

### 问题 2: Excel 文件读取失败
确认:
- 文件路径正确
- 文件格式为 `.xlsx` 或 `.xls`
- 文件没有被其他程序占用

### 问题 3: 字段映射错误
确认 Excel 文件的列名与上述表格完全一致(包括空格和标点符号)

### 问题 4: 院校代码未关联
如果需要关联院校:
1. 确保院校表中有对应的院校代码
2. 先导入院校数据,再导入招生计划数据
3. 或者在导入招生计划后,运行关联脚本

## 性能建议

- 对于大批量数据(超过10000条),建议分批导入
- 导入前可以先备份数据库
- 建议在非高峰时段导入数据

## 技术支持

如遇到问题,请查看:
- 导入日志中的错误详情
- 数据库日志
- 联系技术支持团队
