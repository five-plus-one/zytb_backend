# AIå¯¹è¯è´¨é‡æ”¹è¿›æ–¹æ¡ˆ

## ğŸ“‹ æ¦‚è¿°

æœ¬æ–‡æ¡£æè¿°äº†é’ˆå¯¹å¿—æ„¿å¡«æŠ¥AIåŠ©æ‰‹çš„é‡å¤§æ”¹è¿›ï¼Œæ—¨åœ¨è§£å†³å¯¹è¯ä¸­å‘ç°çš„æ ¸å¿ƒé—®é¢˜ï¼š
- **æ•°æ®ä¸€è‡´æ€§é—®é¢˜**ï¼šAIè®°é”™ç”¨æˆ·åˆ†æ•°
- **æ„å›¾ç†è§£åå·®**ï¼šç”¨æˆ·è¯´"è®¡ç®—æœºæ–¹å‘"å´æ·»åŠ æ‰€æœ‰ä¸“ä¸š
- **çŠ¶æ€ç®¡ç†æ··ä¹±**ï¼šå¿—æ„¿è¡¨æ•°æ®åå¤ä¸¢å¤±
- **ç¼ºä¹ä¸»åŠ¨æ€§**ï¼šéœ€è¦ç”¨æˆ·åå¤å‚¬ä¿ƒå’Œçº é”™

## ğŸ¯ æ ¸å¿ƒæ”¹è¿›

### 1. ä¼šè¯ä¸Šä¸‹æ–‡ç®¡ç†å™¨ (ConversationContextManager)

#### åŠŸèƒ½
- **ç”¨æˆ·æ¡£æ¡ˆå­˜å‚¨**ï¼šè®°ä½ç”¨æˆ·çš„åˆ†æ•°ã€ä½æ¬¡ã€çœä»½ã€ä¸“ä¸šåå¥½ç­‰å…³é”®ä¿¡æ¯
- **å‚æ•°æ ¡éªŒ**ï¼šé˜²æ­¢å·¥å…·è°ƒç”¨æ—¶ä½¿ç”¨é”™è¯¯çš„å‚æ•°ï¼ˆå¦‚åˆ†æ•°ä¸ä¸€è‡´ï¼‰
- **è‡ªåŠ¨è¡¥å…¨**ï¼šæ ¹æ®ç”¨æˆ·åå¥½è‡ªåŠ¨å¡«å……å·¥å…·å‚æ•°
- **æ„å›¾æå–**ï¼šä»ç”¨æˆ·è¾“å…¥ä¸­è‡ªåŠ¨è¯†åˆ«ä¸“ä¸šåå¥½ã€åœ°åŒºåå¥½ç­‰

#### æ–‡ä»¶ä½ç½®
```
src/ai/utils/conversationContext.manager.ts
```

#### æ ¸å¿ƒæ¥å£

```typescript
// ç”¨æˆ·æ¡£æ¡ˆ
interface UserProfile {
  score?: number;              // é«˜è€ƒåˆ†æ•°
  rank?: number;               // çœæ’å
  province?: string;           // çœä»½
  category?: string;           // ç§‘ç±»
  year?: number;               // å¹´ä»½
  preferences: {
    majors?: string[];         // ä¸“ä¸šåå¥½ï¼ˆå¦‚ï¼šè®¡ç®—æœºç§‘å­¦ä¸æŠ€æœ¯ï¼‰
    majorCategories?: string[]; // ä¸“ä¸šå¤§ç±»ï¼ˆå¦‚ï¼šè®¡ç®—æœºç±»ï¼‰
    locations?: string[];      // åœ°åŒºåå¥½ï¼ˆå¦‚ï¼šæ±Ÿè‹çœï¼‰
    collegeTypes?: string[];   // é™¢æ ¡ç±»å‹ï¼ˆå¦‚ï¼š985ã€211ï¼‰
  }
}

// å‚æ•°æ ¡éªŒç»“æœ
interface ValidationResult {
  valid: boolean;
  error?: string;
  correctedParams?: any;  // è‡ªåŠ¨çº æ­£åçš„å‚æ•°
}
```

### 2. å¢å¼ºçš„å·¥å…·é›†æˆ

#### åœ¨ volunteerSmart.tool.ts ä¸­çš„é›†æˆ

```typescript
async execute(params, context) {
  const sessionId = context?.sessionId || 'default';

  // 1. æ ¡éªŒå‚æ•°ä¸€è‡´æ€§
  const validation = this.contextManager.validateToolParams(sessionId, this.name, params);
  if (!validation.valid && validation.correctedParams) {
    params = validation.correctedParams;
    console.warn(validation.error);
  }

  // 2. è‡ªåŠ¨è¡¥å…¨å‚æ•°ï¼ˆæ ¹æ®ç”¨æˆ·åå¥½ï¼‰
  params = this.contextManager.enrichToolParams(sessionId, this.name, params);

  // 3. è®°å½•æŸ¥è¯¢ä¿¡æ¯
  this.contextManager.recordQueriedColleges(sessionId, [...]);

  // 4. è·å–æ‰¹æ¬¡åæ›´æ–°ç”¨æˆ·æ¡£æ¡ˆ
  const batch = await this.volunteerService.getBatchDetail(batchId);
  this.contextManager.updateUserProfile(sessionId, {
    score: batch.score,
    rank: batch.rank,
    province: batch.province,
    category: batch.subjectType,
    year: batch.year
  });
}
```

## ğŸ”§ ä½¿ç”¨ç¤ºä¾‹

### åœºæ™¯1ï¼šé˜²æ­¢åˆ†æ•°ä¸ä¸€è‡´

**ä¹‹å‰çš„é—®é¢˜**ï¼š
```
ç”¨æˆ·ï¼š"æˆ‘638åˆ†"
AIæŸ¥è¯¢æ—¶ä½¿ç”¨ï¼š643åˆ† âŒ
```

**ç°åœ¨çš„è¡Œä¸º**ï¼š
```typescript
// ç”¨æˆ·ç¬¬ä¸€æ¬¡æåˆ°åˆ†æ•°æ—¶
contextManager.updateUserProfile(sessionId, { score: 638 });

// åç»­å·¥å…·è°ƒç”¨æ—¶
validateToolParams(sessionId, 'query_colleges', { score: 643 });
// è¿”å›: { valid: false, correctedParams: { score: 638 } }
// è‡ªåŠ¨çº æ­£ä¸º638åˆ† âœ…
```

### åœºæ™¯2ï¼šè‡ªåŠ¨åº”ç”¨ä¸“ä¸šåå¥½

**ä¹‹å‰çš„é—®é¢˜**ï¼š
```
ç”¨æˆ·ï¼š"æˆ‘æƒ³å­¦è®¡ç®—æœºæ–¹å‘"
AIæŸ¥è¯¢æ—¶ï¼šè¿”å›æ‰€æœ‰ä¸“ä¸š âŒ
```

**ç°åœ¨çš„è¡Œä¸º**ï¼š
```typescript
// ç”¨æˆ·è¯´"è®¡ç®—æœºæ–¹å‘"æ—¶
extractPreferencesFromInput(sessionId, "æˆ‘æƒ³å­¦è®¡ç®—æœºæ–¹å‘");
// è‡ªåŠ¨è®¾ç½®: preferences.majors = ['è®¡ç®—æœºç§‘å­¦ä¸æŠ€æœ¯', 'è½¯ä»¶å·¥ç¨‹']

// åç»­è°ƒç”¨ filter_majors æ—¶
enrichToolParams(sessionId, 'filter_majors', {});
// è‡ªåŠ¨è¡¥å…¨ä¸º: { majorName: 'è®¡ç®—æœºç§‘å­¦ä¸æŠ€æœ¯,è½¯ä»¶å·¥ç¨‹' } âœ…
```

### åœºæ™¯3ï¼šæ‰¹æ¬¡IDè‡ªåŠ¨ç®¡ç†

**ä¹‹å‰çš„é—®é¢˜**ï¼š
```
ç”¨æˆ·ï¼š"åŠ å…¥å¿—æ„¿è¡¨"
AIï¼šé‡å¤åˆ›å»ºæ‰¹æ¬¡ï¼Œå¯¼è‡´æ•°æ®ä¸¢å¤± âŒ
```

**ç°åœ¨çš„è¡Œä¸º**ï¼š
```typescript
// åˆ›å»ºæ‰¹æ¬¡å
recordCurrentBatch(sessionId, batchId);

// åç»­å·¥å…·è°ƒç”¨æ—¶
enrichToolParams(sessionId, 'add_college', {});
// è‡ªåŠ¨è¡¥å…¨ä¸º: { batchId: 'å·²åˆ›å»ºçš„æ‰¹æ¬¡ID' } âœ…
```

## ğŸ“Š é¢„æœŸæ•ˆæœ

### âœ… æ•°æ®ä¸€è‡´æ€§ä¿éšœ
- AIæ— æ³•ä½¿ç”¨ä¸ç”¨æˆ·æä¾›ä¸ä¸€è‡´çš„æ•°æ®
- è‡ªåŠ¨çº æ­£é”™è¯¯å‚æ•°
- å‡å°‘ç”¨æˆ·çº é”™æ¬¡æ•°

### âœ… æ„å›¾å‡†ç¡®ç†è§£
- ç”¨æˆ·è¯´"è®¡ç®—æœºæ–¹å‘"åï¼Œæ‰€æœ‰æŸ¥è¯¢è‡ªåŠ¨å¸¦ä¸Šä¸“ä¸šç­›é€‰
- ç”¨æˆ·è¯´"çœå†…"åï¼Œè‡ªåŠ¨é™å®šåœ°åŒºèŒƒå›´
- å‡å°‘æ— å…³ç»“æœ

### âœ… çŠ¶æ€ç¨³å®šå¯é 
- æ‰¹æ¬¡IDåœ¨ä¼šè¯ä¸­æŒä¹…åŒ–
- é¿å…é‡å¤åˆ›å»ºæ‰¹æ¬¡
- å‡å°‘æ•°æ®ä¸¢å¤±é£é™©

### âœ… ç”¨æˆ·ä½“éªŒæå‡
- ç”¨æˆ·æ— éœ€é‡å¤æä¾›ç›¸åŒä¿¡æ¯
- AIä¸»åŠ¨è®°ä½ç”¨æˆ·åå¥½
- å‡å°‘å¯¹è¯è½®æ¬¡

## ğŸ”„ API å˜æ›´

### ConversationContextManager ä¸»è¦æ–¹æ³•

| æ–¹æ³• | è¯´æ˜ | ä½¿ç”¨åœºæ™¯ |
|------|------|----------|
| `updateUserProfile(sessionId, updates)` | æ›´æ–°ç”¨æˆ·æ¡£æ¡ˆ | ç”¨æˆ·æä¾›åˆ†æ•°ã€ä½æ¬¡ã€é€‰æ‹©ä¸“ä¸šæ–¹å‘æ—¶ |
| `getUserProfile(sessionId)` | è·å–ç”¨æˆ·æ¡£æ¡ˆ | éœ€è¦è¯»å–ç”¨æˆ·ä¿¡æ¯æ—¶ |
| `validateToolParams(sessionId, toolName, params)` | æ ¡éªŒå‚æ•° | å·¥å…·è°ƒç”¨å‰ |
| `enrichToolParams(sessionId, toolName, params)` | è‡ªåŠ¨è¡¥å…¨å‚æ•° | å·¥å…·è°ƒç”¨å‰ |
| `extractPreferencesFromInput(sessionId, input)` | æå–åå¥½ | å¤„ç†ç”¨æˆ·è¾“å…¥æ—¶ |
| `recordCurrentBatch(sessionId, batchId)` | è®°å½•æ‰¹æ¬¡ | åˆ›å»º/è·å–æ‰¹æ¬¡å |
| `recordQueriedColleges(sessionId, colleges)` | è®°å½•æŸ¥è¯¢é™¢æ ¡ | æŸ¥è¯¢é™¢æ ¡å |
| `getStateSnapshot(sessionId)` | è·å–çŠ¶æ€å¿«ç…§ | è°ƒè¯•ã€æ—¥å¿—è®°å½• |

## ğŸ“ é›†æˆæ£€æŸ¥æ¸…å•

åœ¨å…¶ä»–å·¥å…·ä¸­é›†æˆä¸Šä¸‹æ–‡ç®¡ç†å™¨æ—¶ï¼Œè¯·ç¡®ä¿ï¼š

- [ ] å¯¼å…¥ `ConversationContextManager`
- [ ] åœ¨ç±»ä¸­åˆå§‹åŒ–ï¼š`private contextManager = ConversationContextManager.getInstance()`
- [ ] åœ¨ `execute` æ–¹æ³•å¼€å§‹æ—¶ï¼š
  - [ ] è°ƒç”¨ `validateToolParams` æ ¡éªŒå‚æ•°
  - [ ] è°ƒç”¨ `enrichToolParams` è‡ªåŠ¨è¡¥å…¨å‚æ•°
  - [ ] æ ¹æ®éœ€è¦æ›´æ–°ç”¨æˆ·æ¡£æ¡ˆ
  - [ ] è®°å½•æŸ¥è¯¢ç»“æœåˆ°ä¸Šä¸‹æ–‡

## ğŸš€ åç»­æ”¹è¿›å»ºè®®

### ä¼˜å…ˆçº§ P1
1. **æ“ä½œé¢„è§ˆæœºåˆ¶**ï¼šæ‰¹é‡æ“ä½œå‰å±•ç¤ºå°†è¦æ·»åŠ çš„å†…å®¹
2. **æ•°æ®æŒä¹…æ€§éªŒè¯**ï¼šå†™å…¥åç«‹å³éªŒè¯ï¼Œé˜²æ­¢æ•°æ®ä¸¢å¤±
3. **é”™è¯¯è¯Šæ–­ç³»ç»Ÿ**ï¼šæä¾›æ˜ç¡®çš„é”™è¯¯è¯Šæ–­å’Œä¿®å¤å»ºè®®

### ä¼˜å…ˆçº§ P2
4. **ä¸»åŠ¨æ€§å¢å¼º**ï¼šè‡ªåŠ¨å®Œæˆæ˜¾è€Œæ˜“è§çš„ä¸‹ä¸€æ­¥ï¼ˆå¦‚è‡ªåŠ¨æŸ¥è¯¢ä½æ¬¡ï¼‰
5. **ä¿¡æ¯å±•ç¤ºä¼˜åŒ–**ï¼šå‡å°‘å™ªéŸ³ï¼Œæå‡å…³é”®ä¿¡æ¯å¯è¯»æ€§
6. **å¤šè½®å¯¹è¯è¿½è¸ª**ï¼šè®°å½•å¯¹è¯å†å²ï¼Œæä¾›æ›´æ™ºèƒ½çš„ä¸Šä¸‹æ–‡æ„ŸçŸ¥

## ğŸ“š å‚è€ƒèµ„æ–™

### ç›¸å…³æ–‡ä»¶
- [conversationContext.manager.ts](src/ai/utils/conversationContext.manager.ts) - ä¼šè¯ä¸Šä¸‹æ–‡ç®¡ç†å™¨
- [volunteerSmart.tool.ts](src/ai/tools/volunteerSmart.tool.ts) - æ™ºèƒ½å¿—æ„¿å·¥å…·ï¼ˆå·²é›†æˆï¼‰
- [batchHelper.ts](src/ai/utils/batchHelper.ts) - æ‰¹æ¬¡è¾…åŠ©å·¥å…·

### è®¾è®¡æ–‡æ¡£
- [API_DOCUMENTATION.md](API_DOCUMENTATION.md) - API æ–‡æ¡£
- æœ¬æ–‡æ¡£åˆ†æçš„é—®é¢˜å¯¹è¯ï¼ˆè¯¦è§å¼€å‘ä¼šè®®è®°å½•ï¼‰

## ğŸ› å·²çŸ¥é™åˆ¶

1. **Sessionç®¡ç†**ï¼šå½“å‰ä½¿ç”¨å†…å­˜å­˜å‚¨ï¼Œé‡å¯æœåŠ¡åä¼šä¸¢å¤±ã€‚å»ºè®®åç»­ä½¿ç”¨Redisæˆ–æ•°æ®åº“æŒä¹…åŒ–ã€‚
2. **å¹¶å‘å¤„ç†**ï¼šå¤šä¸ªä¼šè¯ä¹‹é—´å®Œå…¨éš”ç¦»ï¼Œæ— æ³•å…±äº«å­¦ä¹ ç»“æœã€‚
3. **æ„å›¾è¯†åˆ«**ï¼šåŸºäºå…³é”®è¯åŒ¹é…ï¼Œå¤æ‚è¯­ä¹‰ç†è§£æœ‰é™ã€‚å»ºè®®åç»­æ¥å…¥NLUæœåŠ¡ã€‚

## ğŸ“ è”ç³»æ–¹å¼

å¦‚æœ‰é—®é¢˜æˆ–å»ºè®®ï¼Œè¯·è”ç³»å¼€å‘å›¢é˜Ÿæˆ–åœ¨ GitHub æ Issueã€‚

---

**æ›´æ–°æ—¶é—´**ï¼š2025-10-31
**ç‰ˆæœ¬**ï¼šv1.0
**ä½œè€…**ï¼šAI æ”¹è¿›å°ç»„
